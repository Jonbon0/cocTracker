<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clan Activity Rankings - Clash of Clans Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="styles.css">
<style>
/* Additional styles for clan rankings */
.activity-rankings {
  background: var(--coc-blue);
  padding: 25px;
  border-radius: 12px;
  margin-bottom: 30px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  border: 1px solid rgba(255,178,56,0.1);
}

.player-row {
  display: grid;
  grid-template-columns: 60px 1fr 120px 150px 180px 150px 150px;
  gap: 15px;
  align-items: center;
  padding: 15px 20px;
  border-radius: 8px;
  margin-bottom: 10px;
  background: rgba(27, 75, 114, 0.3);
  border: 1px solid rgba(255,178,56,0.1);
  transition: all 0.3s ease;
}

.player-row:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  background: rgba(27, 75, 114, 0.5);
}

.header-row {
  background: rgba(255,178,56,0.15) !important;
  font-weight: 600;
  color: var(--coc-gold);
  margin-bottom: 15px;
  border: 1px solid rgba(255,178,56,0.3);
}

.header-row:hover {
  transform: none;
  box-shadow: none;
}

.rank {
  font-size: 1.3em;
  font-weight: bold;
  text-align: center;
  color: var(--coc-gold);
}

.rank-1 {
  color: #FFD700;
  font-size: 1.5em;
}

.rank-2 {
  color: #C0C0C0;
  font-size: 1.4em;
}

.rank-3 {
  color: #CD7F32;
  font-size: 1.4em;
}

.player-name {
  font-weight: 600;
  font-size: 1.1em;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.role {
  text-align: center;
}

.stat {
  text-align: center;
  font-size: 1.05em;
}

.activity-score {
  font-size: 1.2em;
  font-weight: bold;
  text-align: center;
  color: var(--coc-gold);
}

/* Responsive design */
@media (max-width: 1200px) {
  .player-row {
    grid-template-columns: 50px 1fr 100px 120px 120px 120px;
    gap: 10px;
    padding: 12px 15px;
    font-size: 0.95em;
  }
}

@media (max-width: 768px) {
  .player-row {
    grid-template-columns: 40px 1fr 80px 100px;
    gap: 8px;
    padding: 10px;
    font-size: 0.9em;
  }
  
  .stat:nth-child(5) {
    display: none;
  }
  
  .header-row .stat:nth-child(5) {
    display: none;
  }
}
</style>
</head>
<body>
<div class="container">
  <nav>
    <a href="/">Clan Stats</a>
    <a href="/players.html">Player War Stats</a>
    <a href="/activity.html">Activity Tracker</a>
    <a href="/clanActivity.html">Clan Rankings</a>
  </nav>
  
  <h1>Clan Activity Rankings</h1>

  <div class="time-filter">
    <button data-days="7">7 Days</button>
    <button data-days="14">14 Days</button>
    <button data-days="30">30 Days</button>
    <button data-days="60" class="active">60 Days</button>
  </div>

  <div class="activity-rankings">
    <div class="player-row header-row">
      <div class="rank">#</div>
      <div class="player-name">Player</div>
      <div class="role">Role</div>
      <div class="stat" title="War stars earned in the selected time period">War Stars</div>
      <div class="stat">Donations</div>
      <div class="activity-score">Score</div>
    </div>
    <div id="playerRankings">
      <div class="loading">Loading player rankings...</div>
    </div>
  </div>
</div>

<script>
let currentDays = 60;

async function fetchPlayers() {
  try {
    const res = await fetch('/api/players');
    const data = await res.json();
    return data.data || [];
  } catch (err) {
    console.error('Error fetching players:', err);
    return [];
  }
}

async function fetchPlayerStats(playerTag, days) {
  try {
    const res = await fetch(`/api/players/${encodeURIComponent(playerTag)}/stats?days=${days}`);
    if (!res.ok) throw new Error(`Failed to fetch player stats: ${res.status}`);
    const data = await res.json();
    return data.data || [];
  } catch (err) {
    console.error('Error fetching player stats:', err);
    return [];
  }
}

async function calculatePlayerActivity(player, days) {
  // Fetch stats for both display period and activity calculation
  const displayStats = await fetchPlayerStats(player.playerTag, days);
  const activityStats = await fetchPlayerStats(player.playerTag, 60);
  
  if (displayStats.length < 2 || activityStats.length < 2) return null;

  // Sort stats by timestamp to ensure chronological order
  const sortedDisplayStats = [...displayStats].sort((a, b) => 
    new Date(a.timestamp) - new Date(b.timestamp)
  );

  // Calculate war stars gained by looking at each data point
  let warStarsGained = 0;
  for (let i = 1; i < sortedDisplayStats.length; i++) {
    const current = sortedDisplayStats[i];
    const previous = sortedDisplayStats[i - 1];
    const starDiff = current.warStars - previous.warStars;
    if (starDiff > 0) {
      warStarsGained += starDiff;
    }
  }

  // Calculate donations
  const firstDisplayStat = sortedDisplayStats[0];
  const lastDisplayStat = sortedDisplayStats[sortedDisplayStats.length - 1];
  const donationsMade = lastDisplayStat.donations - firstDisplayStat.donations;

  // Calculate activity score (increased war stars weight)
  const activityScore = Math.round(
    (warStarsGained * 50) +        // War stars are worth 50 points each (increased from 30)
    (donationsMade / 100)          // Every 100 donations is worth 1 point
  );

  return {
    player: player,
    warStars: warStarsGained,
    donations: donationsMade,
    activityScore: activityScore
  };
}

async function updateRankings(days) {
  const rankingsDiv = document.getElementById('playerRankings');
  rankingsDiv.innerHTML = '<div class="loading">Loading player rankings...</div>';

  try {
    // Fetch all players
    const players = await fetchPlayers();
    
    // Calculate activity for each player
    const activities = await Promise.all(
      players.map(player => calculatePlayerActivity(player, days))
    );

    // Filter out null results and sort by activity score
    const validActivities = activities
      .filter(activity => activity !== null)
      .sort((a, b) => b.activityScore - a.activityScore);

    // Generate rankings HTML
    const rankingsHtml = validActivities.map((activity, index) => `
      <div class="player-row">
        <div class="rank${index < 3 ? ' rank-' + (index + 1) : ''}">${index + 1}</div>
        <div class="player-name">${activity.player.playerName}</div>
        <div class="role">
          <span class="role-badge">${activity.player.clanRole || 'Member'}</span>
        </div>
        <div class="stat">${activity.warStars.toLocaleString()}</div>
        <div class="stat">${activity.donations.toLocaleString()}</div>
        <div class="activity-score">${activity.activityScore.toLocaleString()}</div>
      </div>
    `).join('');

    rankingsDiv.innerHTML = rankingsHtml;
  } catch (error) {
    console.error('Error updating rankings:', error);
    rankingsDiv.innerHTML = '<div class="loading">Error loading rankings</div>';
  }
}

function initializeTimeFilters() {
  document.querySelectorAll('.time-filter button').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.time-filter button').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      currentDays = parseInt(this.dataset.days) || 60;
      updateRankings(currentDays);
    });
  });
}

// Initialize the application
async function init() {
  try {
    initializeTimeFilters();
    await updateRankings(currentDays);
  } catch (error) {
    console.error('Error initializing:', error);
  }
}

// Start the app when the DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  init();
  // Refresh every 5 minutes
  setInterval(() => updateRankings(currentDays), 5 * 60 * 1000);
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clan Stats - Clash of Clans Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
  <nav>
    <a href="/">Clan Stats</a>
    <a href="/players.html">Player War Stats</a>
    <a href="/activity.html">Activity Tracker</a>
    <a href="/clanActivity.html">Clan Rankings</a>
  </nav>
  
  <h1>Clan Statistics</h1>
  
  <div class="chart-wrapper">
    <h3>Summary Chart</h3>
    <canvas id="summaryChart"></canvas>
  </div>

  <div class="chart-wrapper">
    <h3>Members Over Time</h3>
    <canvas id="membersChart"></canvas>
  </div>
  
  <div class="chart-wrapper">
    <h3>Clan Points Over Time</h3>
    <canvas id="clanPointsChart"></canvas>
  </div>
  
  <div class="chart-wrapper">
    <h3>Capital Points Over Time</h3>
    <canvas id="capitalPointsChart"></canvas>
  </div>
</div>

<script>
async function fetchSnapshots() {
  const res = await fetch('/api/snapshots');
  return await res.json();
}

function renderChart(canvasId, label, data, color, field) {
  return new Chart(document.getElementById(canvasId), {
    type: 'line',
    data: {
      datasets: [{
        label,
        data: data.map(d => ({
          x: new Date(d.timestamp),
          y: d[field]
        })),
        borderColor: color,
        backgroundColor: color + '33',
        fill: true,
        tension: 0.4,
        pointRadius: 3,
        pointHoverRadius: 5,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { 
          display: true, 
          position: 'top',
          labels: {
            boxWidth: 20,
            padding: 20
          }
        },
        tooltip: { 
          enabled: true, 
          mode: 'index', 
          intersect: false,
          callbacks: {
            title: function(tooltipItems) {
              return moment(tooltipItems[0].parsed.x).format('MMM D, YYYY');
            }
          }
        }
      },
      scales: {
        x: {
          type: 'time',
          time: {
            unit: 'day',
            displayFormats: {
              day: 'MMM D'
            }
          },
          title: {
            display: true,
            text: 'Date'
          },
          grid: {
            display: true,
            drawOnChartArea: true
          }
        },
        y: { 
          beginAtZero: true, 
          title: { 
            display: true, 
            text: label 
          },
          grid: {
            drawOnChartArea: true
          }
        }
      },
      animation: {
        duration: 750
      }
    }
  });
}

async function updateCharts() {
  const data = await fetchSnapshots();
  
  // Safely destroy existing charts
  if (window.charts) {
    window.charts.forEach(c => {
      if (c && typeof c.destroy === 'function') c.destroy();
    });
  }
  if (window.summaryChart && typeof window.summaryChart.destroy === 'function') {
    window.summaryChart.destroy();
  }

  // Individual charts
  window.charts = [
    renderChart('membersChart', 'Members', data, '#007bff', 'members'),
    renderChart('clanPointsChart', 'Clan Points', data, '#28a745', 'clanPoints'),
    renderChart('capitalPointsChart', 'Capital Points', data, '#dc3545', 'clanCapitalPoints'),
  ];

  // Combined summary chart
  const summaryCtx = document.getElementById('summaryChart').getContext('2d');
  window.summaryChart = new Chart(summaryCtx, {
    type: 'line',
    data: {
      datasets: [
        { 
          label: 'Members', 
          data: data.map(d => ({
            x: new Date(d.timestamp),
            y: d.members
          })), 
          borderColor: '#007bff', 
          fill: false, 
          tension: 0.4,
          yAxisID: 'y1',
          pointRadius: 3,
          pointHoverRadius: 5,
          borderWidth: 2
        },
        { 
          label: 'Clan Points', 
          data: data.map(d => ({
            x: new Date(d.timestamp),
            y: d.clanPoints
          })), 
          borderColor: '#28a745', 
          fill: false, 
          tension: 0.4,
          yAxisID: 'y2',
          pointRadius: 3,
          pointHoverRadius: 5,
          borderWidth: 2
        },
        { 
          label: 'Clan Level', 
          data: data.map(d => ({
            x: new Date(d.timestamp),
            y: d.clanLevel
          })), 
          borderColor: '#ffc107', 
          fill: false, 
          tension: 0.4,
          yAxisID: 'y1',
          pointRadius: 3,
          pointHoverRadius: 5,
          borderWidth: 2
        },
        { 
          label: 'Capital Points', 
          data: data.map(d => ({
            x: new Date(d.timestamp),
            y: d.clanCapitalPoints
          })), 
          borderColor: '#dc3545', 
          fill: false, 
          tension: 0.4,
          yAxisID: 'y2',
          pointRadius: 3,
          pointHoverRadius: 5,
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { 
          position: 'top',
          labels: {
            boxWidth: 20,
            padding: 20
          }
        }, 
        tooltip: { 
          mode: 'index', 
          intersect: false,
          callbacks: {
            title: function(tooltipItems) {
              return moment(tooltipItems[0].parsed.x).format('MMM D, YYYY');
            }
          }
        }
      },
      scales: {
        x: {
          type: 'time',
          time: {
            unit: 'day',
            displayFormats: {
              day: 'MMM D'
            }
          },
          title: {
            display: true,
            text: 'Date'
          },
          grid: {
            display: true,
            drawOnChartArea: true
          }
        },
        y1: { 
          type: 'linear',
          display: true,
          position: 'left',
          title: { display: true, text: 'Members & Level' },
          beginAtZero: true,
          grid: {
            drawOnChartArea: true
          }
        },
        y2: { 
          type: 'linear',
          display: true,
          position: 'right',
          title: { display: true, text: 'Points' },
          beginAtZero: true,
          grid: { 
            display: false 
          }
        }
      },
      animation: {
        duration: 750
      }
    }
  });
}

// Initial render
updateCharts();
// Refresh every 1 minute
setInterval(updateCharts, 60 * 1000);
</script>
</body>
</html>
